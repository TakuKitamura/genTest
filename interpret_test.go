package main

import (
	"bufio"
	"bytes"
	"fmt"
	"genTest/core"
	"os"
	"testing"
)

func TestInterpret(t *testing.T) {
	os.Setenv("GENTEST_MODE", "TEST")

	fp, _ := os.Open("./sample_code/grammar_example.gent")

	scanner := bufio.NewScanner(fp)

	w := new(bytes.Buffer)

	err := core.Exec(scanner, w)

	if err != nil {
		errMsg := err.Error()
		t.Fatal(errMsg)
	}

	output := w.String()

	expected := `このようなことしかできません｡
できることその1: 演算
(2.0 + (3.0 - 4.0) / 5.0) + 0.1 * 2.0 is 2.0000000000000000
できることその2: 評価
1 < 2 && (3 != 3 || true) is true
できることその3: 文字列結合
できることその4: IF文による分岐
2020 年は
うるう年です｡
できることその5: FOR文による分岐
ライプニッツの公式(n=10)より
π ≒ 3.0418396189294028
演算
結果1: 0.6000000000000001
結果2: 0.0000000000000000
結果3: -0.6000000000000001
式評価
結果1: true
結果2: false
結果3: false
IF文
3
4
5
FOR文
i: 0 j: 0 k: 0
i: 0 j: 0 k: 1.0000000000000000
i: 0 j: 0 k: 2.0000000000000000
i: 0 j: 1.0000000000000000 k: 0
i: 0 j: 1.0000000000000000 k: 1.0000000000000000
i: 0 j: 1.0000000000000000 k: 2.0000000000000000
i: 0 j: 2.0000000000000000 k: 0
i: 0 j: 2.0000000000000000 k: 1.0000000000000000
i: 0 j: 2.0000000000000000 k: 2.0000000000000000
i: 1.0000000000000000 j: 0 k: 0
i: 1.0000000000000000 j: 0 k: 1.0000000000000000
i: 1.0000000000000000 j: 0 k: 2.0000000000000000
i: 1.0000000000000000 j: 1.0000000000000000 k: 0
i: 1.0000000000000000 j: 1.0000000000000000 k: 1.0000000000000000
i: 1.0000000000000000 j: 1.0000000000000000 k: 2.0000000000000000
i: 1.0000000000000000 j: 2.0000000000000000 k: 0
i: 1.0000000000000000 j: 2.0000000000000000 k: 1.0000000000000000
i: 1.0000000000000000 j: 2.0000000000000000 k: 2.0000000000000000
i: 2.0000000000000000 j: 0 k: 0
i: 2.0000000000000000 j: 0 k: 1.0000000000000000
i: 2.0000000000000000 j: 0 k: 2.0000000000000000
i: 2.0000000000000000 j: 1.0000000000000000 k: 0
i: 2.0000000000000000 j: 1.0000000000000000 k: 1.0000000000000000
i: 2.0000000000000000 j: 1.0000000000000000 k: 2.0000000000000000
i: 2.0000000000000000 j: 2.0000000000000000 k: 0
i: 2.0000000000000000 j: 2.0000000000000000 k: 1.0000000000000000
i: 2.0000000000000000 j: 2.0000000000000000 k: 2.0000000000000000
関数
Hello!
6.0000000000000000
π ≒ 3.1415926535897940
`

	if output != expected {
		errMsg := fmt.Sprintf("Expected output is \"%s\", but actual is \"%s\".", expected, output)
		t.Fatal(errMsg)
	}
}
